#!/usr/bin/env python3
"""
Misc sections for my tmux status-line. Here I throw in any status-line elements
I haven't created any dedicated scripts for (... yet).
"""

import re
import subprocess
from distutils.spawn import find_executable as which

from shared import print_loop, render_loop

def nordvpn(args):
    """Nordvpn status-line section."""
    if not which('nordvpn'):
        return None
    proc = subprocess.run(['nordvpn', 'status'], capture_output=True)
    out = proc.stdout.decode('utf-8')
    match = re.search(r'Status: (.+)', out, flags=re.IGNORECASE)
    if not match:
        return None
    connected = match[1].lower() == 'connected'
    if args.nordvpn_hide and not connected:
        return None
    ip_address = ''
    match = re.search('Your new IP: (.+)', out, re.IGNORECASE)
    if match:
        ip_address = ' ' + match[1]
    return (args.nordvpn_active_style if connected
            else args.nordvpn_inactive_style) \
        + args.nordvpn_icon + args.reset_style + ip_address

def status_misc(args):
    """Closure around args continually outputting meta-data.
    """
    statuses = [x for x in (args.nordvpn,) if x]

    def wrapped():
        msgs = (x(args) for x in statuses)
        msgs = [x for x in msgs if x]
        if msgs:
            return args.sep.join(msgs) + args.suffix
        return ''
    return wrapped


if __name__ == '__main__':
    import argparse

    parser = argparse.ArgumentParser()

    parser.add_argument('--suffix',
                        metavar='FORMAT', default='',
                        help='Suffix output with FORMAT.')

    nvpngroup = parser.add_argument_group('Nord VPN')
    nvpngroup.add_argument('--nordvpn',
                           action='store_const', const=nordvpn,
                           help='Show indicator for nordvpn status.')
    nvpngroup.add_argument('--nordvpn-icon', default='N', metavar='ICON',
                           help='Icon shown to indicate nordvpn status.')
    nvpngroup.add_argument('--nordvpn-hide',
                           action='store_true',
                           help='Hide nordvpn status when disconnected')
    nvpngroup.add_argument('--nordvpn-active-style', metavar='STYLE',
                           default='',
                           help='Styling for an active nordvpn connection.')
    nvpngroup.add_argument('--nordvpn-inactive-style', metavar='STYLE',
                           default='',
                           help='Styling for an inactive nordvpn connection.')

    parser.add_argument('--sep', metavar='STRING', default=' ',
                        help='Concatenate status indicators with STRING')
    parser.add_argument('-r', '--reset-style', default='#[default]',
                        help='Specify style for resetting styles')
    parser.add_argument('-u', '--unbuffer', action='store_true',
                        help='Immeadiately flush output after writing')
    parser.add_argument('-s', '--sleep', type=int,
                        help='When given, wait this duration between outputting')

    args  = parser.parse_args()
    vargs = vars(args)

    try:
        print_loop(render_loop(status_misc(args)), args.unbuffer, args.sleep)
    except KeyboardInterrupt:
        pass
